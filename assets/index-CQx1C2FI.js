var fe=Object.defineProperty;var he=(e,n,a)=>n in e?fe(e,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[n]=a;var O=(e,n,a)=>he(e,typeof n!="symbol"?n+"":n,a);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const p of document.querySelectorAll('link[rel="modulepreload"]'))m(p);new MutationObserver(p=>{for(const d of p)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&m(c)}).observe(document,{childList:!0,subtree:!0});function a(p){const d={};return p.integrity&&(d.integrity=p.integrity),p.referrerPolicy&&(d.referrerPolicy=p.referrerPolicy),p.crossOrigin==="use-credentials"?d.credentials="include":p.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function m(p){if(p.ep)return;p.ep=!0;const d=a(p);fetch(p.href,d)}})();class de{constructor(){O(this,"logicalW",256);O(this,"logicalH",240);O(this,"screen",document.createElement("canvas"));O(this,"ctx",this.screen.getContext("2d"));O(this,"view",document.querySelector("#view"));O(this,"viewCtx",this.view.getContext("2d"));O(this,"fixedScale",2);this.screen.width=this.logicalW,this.screen.height=this.logicalH,this.viewCtx.imageSmoothingEnabled=!1,this.view.width=this.logicalW*this.fixedScale,this.view.height=this.logicalH*this.fixedScale}resize(){this.view.width=this.logicalW*this.fixedScale,this.view.height=this.logicalH*this.fixedScale}get ctx2d(){return this.ctx}clear(n="#000"){this.ctx.fillStyle=n,this.ctx.fillRect(0,0,this.logicalW,this.logicalH)}present(){this.viewCtx.clearRect(0,0,this.view.width,this.view.height),this.viewCtx.drawImage(this.screen,0,0,this.logicalW*this.fixedScale,this.logicalH*this.fixedScale)}}function ue(e,n){const a=16.666666666666668;let m=0,p=performance.now();function d(c){for(m+=c-p,p=c;m>=a;)e(a/1e3),m-=a;n(),requestAnimationFrame(d)}requestAnimationFrame(d)}class me{constructor(){O(this,"keys",{});const n=a=>{const m=a.toLowerCase();return m===" "||m.startsWith("arrow")||m==="w"||m==="a"||m==="s"||m==="d"};addEventListener("keydown",a=>{const m=a.key.toLowerCase();this.keys[m]=!0,n(m)&&a.preventDefault()},{passive:!1}),addEventListener("keyup",a=>{const m=a.key.toLowerCase();this.keys[m]=!1,n(m)&&a.preventDefault()},{passive:!1})}axis(){const n=this.keys,a=(n.arrowright||n.d?1:0)-(n.arrowleft||n.a?1:0),m=(n.arrowdown||n.s?1:0)-(n.arrowup||n.w?1:0),p=!!n[" "];return{x:a,y:m,attack:p}}}async function se(e){return new Promise((n,a)=>{const m=new Image;m.onload=()=>n(m),m.onerror=a,m.src=e})}async function ye(e){const n=await fetch(e);if(!n.ok)throw new Error("Failed to load "+e);return n.json()}function re(e){const n=[];for(let a=0;a<15;a++){const m=[];for(let p=0;p<16;p++)m.push(e);n.push(m)}return n}function ne(e=!1){const n=[];for(let a=0;a<15;a++){const m=[];for(let p=0;p<16;p++)m.push(e);n.push(m)}return n}function ie(e,n){for(let a=0;a<16;a++)e[0][a]="wall",e[14][a]="wall",n[0][a]=!0,n[14][a]=!0;for(let a=0;a<15;a++)e[a][0]="wall",e[a][15]="wall",n[a][0]=!0,n[a][15]=!0}function R(e,n,a,m,p,d=!0){e[m][a]=p,d&&(n[m][a]=!0)}function xe(){function a(f,x,o){if(o==="E"||o==="W")for(let E=-2;E<2;E++){const H=7+E,j=o==="E"?15:0;x[H][j]=!1;const B=o==="E"?14:1;f[H][j]=f[H][B];const Q=o==="E"?14:1;f[H][Q]="floor";const G=o==="E"?13:2;H>=1&&H<=13&&(f[H][G]="floor")}else for(let E=-2;E<3;E++){const H=8+E,j=o==="S"?14:0;x[j][H]=!1;const B=o==="S"?13:1;f[j][H]=f[B][H];const Q=o==="S"?13:1;f[Q][H]="floor";const G=o==="S"?12:2;H>=1&&H<=14&&(f[G][H]="floor")}}function m(f,x,o){const E=re(f),H=ne(!1);ie(E,H);for(const j of["N","S","E","W"])x[j]&&a(E,H,j);return o&&o(E,H),{tiles:E,solids:H}}const p=re("grass"),d=ne(!1);ie(p,d);for(let f=-2;f<2;f++){const x=7+f;d[x][15]=!1,p[x][15]="grass",p[x][14]="floor",x>=1&&x<=13&&(p[x][13]="floor")}for(let f=-2;f<3;f++){const x=8+f;d[14][x]=!1,p[14][x]="grass",p[13][x]="floor",x>=1&&x<=14&&(p[12][x]="floor")}R(p,d,5,6,"tree",!0),R(p,d,9,4,"rock",!0),R(p,d,10,10,"rock",!0);const c=m("grass",{W:!0,N:!0},(f,x)=>{for(let o=5;o<=7;o++)for(let E=10;E<=12;E++)f[o][E]="water",x[o][E]=!0;R(f,x,8,8,"chest",!0),R(f,x,2,3,"tree",!0),R(f,x,13,10,"rock",!0)}),D=m("grass",{S:!0,W:!0},(f,x)=>{R(f,x,4,4,"tree",!0),R(f,x,11,10,"rock",!0),x[5][9]||(f[5][9]="water",x[5][9]=!0)}),W=m("grass",{E:!0,N:!0},(f,x)=>{R(f,x,3,10,"tree",!0),R(f,x,12,4,"rock",!0),x[9][6]||(f[9][6]="water",x[9][6]=!0)}),N=m("grass",{S:!0,W:!0},(f,x)=>{for(let o=5;o<=11;o++)f[2][o]="wall",x[2][o]=!0;for(let o=3;o<=5;o++)f[o][5]="wall",x[o][5]=!0;for(let o=3;o<=5;o++)f[o][11]="wall",x[o][11]=!0;f[0][8]="door",x[0][8]=!1,f[1][8]="floor"}),C=m("grass",{E:!0},(f,x)=>{R(f,x,6,6,"rock",!0),R(f,x,10,8,"tree",!0)}),r=m("floor",{N:!0,E:!0},(f,x)=>{for(let o=4;o<=10;o+=3)for(let E=4;E<=12;E+=4)R(f,x,E,o,"wall",!0);for(let o=6;o<=10;o++)f[1][o]="floor";for(let o=6;o<=10;o++)f[o][14]="floor";f[8][5]="floor",f[9][6]="floor"}),X=m("floor",{W:!0,S:!0},(f,x)=>{for(let o=5;o<=9;o+=2)R(f,x,8,o,"wall",!0);for(let o=6;o<=10;o++)f[o][1]="floor";for(let o=6;o<=10;o++)f[13][o]="floor";R(f,x,3,4,"wall",!0),R(f,x,12,11,"wall",!0)}),U=m("floor",{N:!0,E:!0},(f,x)=>{for(let o=6;o<=9;o++)f[6][o]="floor";for(let o=6;o<=10;o++)f[1][o]="floor";for(let o=6;o<=10;o++)f[o][14]="floor";R(f,x,5,9,"wall",!0)}),Y=m("floor",{W:!0,S:!0},(f,x)=>{for(let o=5;o<=11;o++)f[2][o]="wall",x[2][o]=!0;for(let o=3;o<=5;o++)f[o][5]="wall",x[o][5]=!0;for(let o=3;o<=5;o++)f[o][11]="wall",x[o][11]=!0;f[0][8]="door",x[0][8]=!1,f[1][8]="floor";for(let o=6;o<=10;o++)f[o][1]="floor";for(let o=6;o<=10;o++)f[13][o]="floor";f[8][3]="floor",f[9][12]="floor"}),L=m("floor",{N:!0},(f,x)=>{for(let o=4;o<=12;o+=2)R(f,x,o,10,"wall",!0);for(let o=6;o<=10;o++)f[1][o]="floor";R(f,x,7,7,"wall",!0)}),P=m("floor",{S:!0},(f,x)=>{for(let o=0;o<15;o++)for(let E=0;E<16;E++)f[o][E]="void";for(let o=6;o<=10;o++)f[13][o]="floor";for(let o=6;o<=10;o++)f[12][o]="floor";for(let o=4;o<=11;o++)f[6][o]="wall",x[6][o]=!0}),$=m("floor",{S:!0},(f,x)=>{for(let o=0;o<15;o++)for(let E=0;E<16;E++)f[o][E]="void";for(let o=6;o<=10;o++)f[13][o]="floor";for(let o=6;o<=10;o++)f[12][o]="floor";for(let o=4;o<=11;o++)f[6][o]="wall",x[6][o]=!0});return{rooms:{start:{id:"start",tiles:p,exits:{E:"meadow",S:"cave"},colliders:d,entities:["hero"]},meadow:{id:"meadow",tiles:c.tiles,exits:{W:"start",N:"meadow2"},colliders:c.solids,entities:["slime"]},meadow2:{id:"meadow2",tiles:D.tiles,exits:{S:"meadow",W:"meadow3"},colliders:D.solids,entities:["slime"]},meadow3:{id:"meadow3",tiles:W.tiles,exits:{E:"meadow2",N:"meadow4"},colliders:W.solids,entities:["slime"]},meadow4:{id:"meadow4",tiles:N.tiles,exits:{S:"meadow3",W:"meadow5",N:"shop_meadow"},colliders:N.solids,entities:["slime"]},meadow5:{id:"meadow5",tiles:C.tiles,exits:{E:"meadow4"},colliders:C.solids,entities:["slime"]},shop_meadow:{id:"shop_meadow",tiles:P.tiles,exits:{S:"meadow4"},colliders:P.solids,entities:[]},cave:{id:"cave",tiles:r.tiles,exits:{N:"start",E:"cave2"},colliders:r.solids,entities:["bat"]},cave2:{id:"cave2",tiles:X.tiles,exits:{W:"cave",S:"cave3"},colliders:X.solids,entities:["bat"]},cave3:{id:"cave3",tiles:U.tiles,exits:{N:"cave2",E:"cave4"},colliders:U.solids,entities:["bat"]},cave4:{id:"cave4",tiles:Y.tiles,exits:{W:"cave3",S:"cave5",N:"shop_cave"},colliders:Y.solids,entities:["bat"]},cave5:{id:"cave5",tiles:L.tiles,exits:{N:"cave4"},colliders:L.solids,entities:["bat"]},shop_cave:{id:"shop_cave",tiles:$.tiles,exits:{S:"cave4"},colliders:$.solids,entities:[]}},current:"start",cameraX:0,cameraY:0,transitioning:!1}}class we{constructor(n,a,m){O(this,"t",0);O(this,"from",{x:0,y:0});O(this,"to",{x:0,y:0});O(this,"prevId",null);O(this,"nextId",null);O(this,"dir",null);O(this,"justCompleted",!1);this.world=n,this.w=a,this.h=m}startTransition(n){const a=this.world.current,m=this.world.rooms[a].exits[n];if(!m||this.world.transitioning)return;const p=n==="E"?this.w:n==="W"?-this.w:0,d=n==="S"?this.h:n==="N"?-this.h:0;this.prevId=a,this.nextId=m,this.dir=n,this.world.transitioning=!0,this.t=0,this.world.cameraX=0,this.world.cameraY=0,this.from={x:0,y:0},this.to={x:p,y:d}}update(n){if(!this.world.transitioning)return;this.t+=n*2;const a=this.progress();this.world.cameraX=this.from.x+(this.to.x-this.from.x)*a,this.world.cameraY=this.from.y+(this.to.y-this.from.y)*a,a===1&&(this.world.transitioning=!1,this.nextId&&(this.world.current=this.nextId),this.world.cameraX=0,this.world.cameraY=0,this.prevId=null,this.nextId=null,this.justCompleted=!0)}progress(){return Math.min(1,Math.max(0,(a=>a<.5?2*a*a:1-Math.pow(-2*a+2,2)/2)(this.t)))}}function K(e,n,a,m,p=16){let d=e.x+n.dx*n.speed*a,c=e.y+n.dy*n.speed*a;function D(W,N,C,r){var P;const X=Math.floor(W/p),U=Math.floor((W+C-1)/p),Y=Math.floor(N/p),L=Math.floor((N+r-1)/p);for(let $=Y;$<=L;$++)for(let F=X;F<=U;F++)if((P=m[$])!=null&&P[F])return!0;return!1}if(!D(d,e.y,e.w,e.h))e.x=d;else{const W=Math.sign(n.dx);if(W!==0)for(;!D(e.x+W,e.y,e.w,e.h);)e.x+=W}if(!D(e.x,c,e.w,e.h))e.y=c;else{const W=Math.sign(n.dy);if(W!==0)for(;!D(e.x,e.y+W,e.w,e.h);)e.y+=W}}function pe(e,n){return{x:e,y:n,w:12,h:12,dx:0,dy:0,speed:60,dir:"D",state:"idle",animTime:0,hearts:6,maxHearts:6,invulnTime:0,knockbackTime:0,knockbackVx:0,knockbackVy:0,swingId:0}}function ge(e,n,a,m){if(e.invulnTime>0&&(e.invulnTime=Math.max(0,e.invulnTime-a)),e.knockbackTime>0){const p=a;K(e,{dx:e.knockbackVx,dy:e.knockbackVy,speed:e.speed*1.2},p,m,16),e.knockbackTime=Math.max(0,e.knockbackTime-a),e.animTime+=a;return}if(e.state==="swing"){e.animTime+=a,e.animTime>=.25&&(e.state=Math.abs(n.x)+Math.abs(n.y)?"walk":"idle",e.animTime=0);return}e.dx=Math.sign(n.x),e.dy=Math.sign(n.y),Math.abs(e.dx)&&Math.abs(e.dy)&&(e.dx*=.7071,e.dy*=.7071),Math.abs(e.dx)>Math.abs(e.dy)?e.dir=e.dx<0?"L":"R":Math.abs(e.dy)>.01&&(e.dir=e.dy<0?"U":"D"),Math.abs(e.dx)+Math.abs(e.dy)>.01?e.state="walk":e.state="idle",K(e,{dx:e.dx,dy:e.dy,speed:e.speed},a,m,16),n.attack?(e.state="swing",e.animTime=0,e.swingId++):e.animTime+=a}function le(e){return e.state==="walk"?`hero_walk_${Math.floor(e.animTime*8)%2}`:"hero_walk_0"}function Z(e,n,a,m={}){const p={x:n,y:a,w:m.w??12,h:m.h??12,dx:0,dy:0,speed:m.speed??(e==="slime"?30:45),animTime:0,aiTime:0,hp:m.hp??1,maxHp:m.maxHp??m.hp??1,scale:m.scale??1,lastHitSwingId:-1,knockbackVx:0,knockbackVy:0,knockbackTime:0};return{type:e,...p}}function ve(e){const n=Math.floor(e.animTime*8)%2;return`${e.type}_${n}`}function ke(e,n,a,m,p,d){for(const c of e){if(c.animTime+=a,c.aiTime-=a,(c.knockbackTime||0)>0){K(c,{dx:c.knockbackVx||0,dy:c.knockbackVy||0,speed:180},a,m,16),c.knockbackTime=Math.max(0,(c.knockbackTime||0)-a);continue}if(c.type==="slime"){if(c.aiTime<=0){if(Math.random()<.4){const W=Math.sign(n.x-c.x),N=Math.sign(n.y-c.y),C=Math.hypot(W,N)||1;c.dx=W/C,c.dy=N/C}else{const W=[[1,0],[-1,0],[0,1],[0,-1],[0,0]],[N,C]=W[Math.random()*W.length|0];c.dx=N,c.dy=C}if(Math.abs(c.dx)&&Math.abs(c.dy)){const W=1/Math.SQRT2;c.dx*=W,c.dy*=W}c.aiTime=.6+Math.random()*.9}K(c,{dx:c.dx,dy:c.dy,speed:c.speed},a,m,16)}else if(c.type==="bat"){const D=n.x-c.x,W=n.y-c.y,N=Math.hypot(D,W);if(N<48){const C=N||1,r=c.speed*a/C;c.x+=D*r,c.y+=W*r}else{if(c.aiTime<=0){const C=Math.random()*Math.PI*2;c.dx=Math.cos(C),c.dy=Math.sin(C),c.aiTime=.5+Math.random()*1}c.x+=c.dx*c.speed*.3*a,c.y+=c.dy*c.speed*.3*a}c.x=Math.max(0,Math.min(p-c.w,c.x)),c.y=Math.max(0,Math.min(d-c.h,c.y))}}}function ee(e){return e.state!=="swing"||e.animTime<.085||e.animTime>.25?null:e.dir==="R"?{x:e.x+e.w,y:e.y+2,w:10,h:8}:e.dir==="L"?{x:e.x-10,y:e.y+2,w:10,h:8}:e.dir==="U"?{x:e.x+2,y:e.y-10,w:8,h:10}:{x:e.x+2,y:e.y+e.h,w:8,h:10}}function ae(e,n){return e.x<n.x+n.w&&e.x+e.w>n.x&&e.y<n.y+n.h&&e.h+e.y>n.y}async function Me(e){const[n,a,m]=await Promise.all([ye("assets/sprites_atlas.json"),se("assets/tileset.png"),se("assets/spritesheet.png")]),p={tileset:a,sprites:m},d=xe(),c=new we(d,e.logicalW,e.logicalH),D=new me;function W(){if(d.transitioning)return;const t=d.rooms[d.current];let u=-1,l=-1;for(let h=1;h<14&&u<0;h++)for(let s=1;s<15;s++)if(t.tiles[h][s]==="door"){u=s,l=h;break}if(u<0)return;const y=16,v={x:u*y,y:l*y,w:y,h:y};if(!!(r.x+r.w<=v.x||v.x+v.w<=r.x||r.y+r.h<=v.y||v.y+v.h<=r.y))return;let i="N";l<=1?i="N":l>=13?i="S":u<=1?i="W":u>=14&&(i="E"),t.exits[i]&&c.startTransition(i)}function N(t,u,l,y,v=!1,M=0,i=1){const h=n.sprites[u];if(!h)return;t.save();const s=t.imageSmoothingEnabled,w=t.imageSmoothingQuality;if(i>1){t.imageSmoothingEnabled=!0;try{t.imageSmoothingQuality="high"}catch{}}if(M!==0){const T=l+h.w*i/2,g=y+h.h*i/2;t.translate(T,g),t.rotate(M),v&&t.scale(-1,1),i!==1&&t.scale(i,i),t.drawImage(p.sprites,h.x,h.y,h.w,h.h,-h.w/2,-h.h/2,h.w,h.h)}else v||i!==1?(t.translate(l,y),v&&(t.translate(h.w*i,0),t.scale(-1,1)),i!==1&&t.scale(i,i),t.drawImage(p.sprites,h.x,h.y,h.w,h.h,0,0,h.w,h.h)):t.drawImage(p.sprites,h.x,h.y,h.w,h.h,l,y,h.w,h.h);if(t.restore(),i>1){t.imageSmoothingEnabled=s;try{t.imageSmoothingQuality=w}catch{}}}function C(t,u,l,y="#2ecc71"){const v=y==="#3498db"&&n.sprites.rupee_blue?"rupee_blue":y==="#2ecc71"&&n.sprites.rupee_green?"rupee_green":null;if(v){N(t,v,Math.floor(u),Math.floor(l));return}t.save(),t.translate(Math.floor(u),Math.floor(l)),t.fillStyle=y;const M=["...1....","..111...",".11111..","..111...","...1...."];for(let i=0;i<M.length;i++){const h=M[i];for(let s=0;s<h.length;s++)h[s]==="1"&&t.fillRect(s,i,1,1)}t.restore()}const r=pe(8*16-6,7*16-6);function X(t,u){const l=d.rooms[t],y=[],v={start:[{x:15,y:7},{x:8,y:14}],meadow:[{x:0,y:7}],cave:[{x:8,y:0}]},M=4,i=[];for(let s=1;s<14;s++)for(let w=1;w<15;w++)!l.colliders[s][w]&&l.tiles[s][w]!=="door"&&(v[t]||[]).every(S=>Math.hypot(w-S.x,s-S.y)>=M)&&i.push({x:w,y:s});function h(s){return y.every(w=>Math.hypot(w.x-s.x,w.y-s.y)>=3)}for(let s=0;s<i.length&&y.length<u;s++){const w=s*13%i.length,T=i[w];h(T)&&y.push(T)}for(;y.length<u&&i.length;)y.push(i[y.length%i.length]);return y}function U(){const t={};for(const l of Object.keys(d.rooms))t[l]=[];const u=(l,y,v)=>{const M=X(l,v);t[l].push(...M.map(i=>Z(y,i.x*16,i.y*16)))};for(const l of["meadow","meadow2","meadow3","meadow4"])u(l,"slime",4);{const y=X("meadow5",1)[0]||{x:7,y:7};t.meadow5.push(Z("slime",y.x*16,y.y*16,{hp:10,maxHp:10,scale:2,w:32,h:32,speed:26}))}u("cave","bat",7);for(const l of["cave2","cave3","cave4"])u(l,"bat",6);{const y=X("cave5",1)[0]||{x:7,y:7};t.cave5.push(Z("bat",y.x*16,y.y*16,{hp:10,maxHp:10,scale:2,w:32,h:32,speed:48}))}return t.start=[],t.shop_meadow=[],t.shop_cave=[],t}let Y=U();const L={},P={};let $=0;const F=new Set,A={};for(const[t,u]of Object.entries(d.rooms)){const l=[];for(let y=0;y<u.tiles.length;y++)for(let v=0;v<u.tiles[y].length;v++)u.tiles[y][v]==="chest"&&l.push({x:v,y});A[t]=l}if(!["cave","cave2","cave3","cave4"].some(t=>A[t]&&A[t].length>0||!1)){const t="cave3",u=d.rooms[t],l=6,y=7;u.colliders[y][l]||(u.tiles[y][l]="chest",u.colliders[y][l]=!0,A[t]=A[t]||[],A[t].push({x:l,y}))}function o(t,u){const l=e.logicalW-64,y=4;n.sprites.rupee_green?N(t,"rupee_green",l,y):C(t,l,y,"#2ecc71"),t.fillStyle="#9ad",t.font="10px monospace",t.fillText("x "+String(u),l+12,y+8)}const E={shop_meadow:{x:8*16-6,y:8*16,price:10,purchased:!1},shop_cave:{x:8*16-6,y:8*16,price:10,purchased:!1}};function H(t,u,l){(L[t]||(L[t]=[])).push({x:u+4,y:l+4,vx:0,vy:-70,t:3,color:"#3498db",value:5,collectDelay:.3,landed:!1})}function j(t,u){const l=L[t];if(!l)return;const y=d.rooms[t].colliders,v=e.logicalW,M=e.logicalH,i=(h,s)=>{var g;const w=Math.floor(h/16),T=Math.floor(s/16);return!!((g=y[T])!=null&&g[w])};for(let h=l.length-1;h>=0;h--){const s=l[h];if(s.t-=u,s.collectDelay=Math.max(0,s.collectDelay-u),!s.landed){s.vy+=180*u;const w=Math.max(0,Math.min(v-8,s.x+s.vx*u)),T=Math.max(0,Math.min(M-8,s.y+s.vy*u));i(w,T)||i(w+7,T)||i(w,T+7)||i(w+7,T+7)?(s.vx=0,s.vy=0,s.landed=!0):(s.x=w,s.y=T,s.vx*=.92,s.vy*=.92),(Math.hypot(s.vx,s.vy)<8||s.t<2.2)&&(s.vx=0,s.vy=0,s.landed=!0)}if(s.landed&&s.collectDelay<=0&&!(r.x+r.w<=s.x||s.x+8<=r.x||r.y+r.h<=s.y||s.y+8<=r.y)){$+=s.value,l.splice(h,1);continue}s.t<=0&&l.splice(h,1)}}function B(t,u){const l=P[t];if(!l)return;const y=d.rooms[t].colliders,v=e.logicalW,M=e.logicalH,i=(h,s)=>{var g;const w=Math.floor(h/16),T=Math.floor(s/16);return!!((g=y[T])!=null&&g[w])};for(let h=l.length-1;h>=0;h--){const s=l[h];if(s.t-=u,s.collectDelay=Math.max(0,s.collectDelay-u),!s.landed){s.vy+=180*u;const w=Math.max(0,Math.min(v-6,s.x+s.vx*u)),T=Math.max(0,Math.min(M-5,s.y+s.vy*u));i(w,T)||i(w+5,T)||i(w,T+4)||i(w+5,T+4)?(s.vx=0,s.vy=0,s.landed=!0):(s.x=w,s.y=T,s.vx*=.92,s.vy*=.92),(Math.hypot(s.vx,s.vy)<8||s.t<2.2)&&(s.vx=0,s.vy=0,s.landed=!0)}if(s.landed&&s.collectDelay<=0&&!(r.x+r.w<=s.x||s.x+6<=r.x||r.y+r.h<=s.y||s.y+5<=r.y)){r.hearts=Math.min(6,r.hearts+2),l.splice(h,1);continue}s.t<=0&&l.splice(h,1)}}function Q(){var i;const t=d.rooms[d.current],u=ee(r);if(!u)return;const l=Math.floor(u.x/16),y=Math.floor((u.x+u.w-1)/16),v=Math.floor(u.y/16),M=Math.floor((u.y+u.h-1)/16);for(let h=v;h<=M;h++)for(let s=l;s<=y;s++)if(((i=t.tiles[h])==null?void 0:i[s])==="chest"){const w=`${d.current}:${s},${h}`;if(F.has(w))continue;F.add(w),t.tiles[h][s]=t&&n.tiles.chest_open?"chest_open":"floor",t.colliders[h][s]=!1,H(d.current,s*16,h*16);return}}function G(t,u,l,y){const v=n.tiles[u];if(!v){t.fillStyle="#000",t.fillRect(l,y,16,16);return}t.drawImage(p.tileset,v.x,v.y,v.w,v.h,l,y,v.w,v.h)}function ce(t,u){const l=[".11.1.","111111",".1111.","..11..","...1.."],y=Math.floor(u/2),v=u%2,M=4,i=4,h=8,s=(w,T,g)=>{t.save(),t.translate(Math.floor(w),Math.floor(T)),t.fillStyle="#e33";for(let S=0;S<l.length;S++){const _=l[S];for(let b=0;b<_.length;b++)_[b]==="1"&&(g&&b>=3||t.fillRect(b,S,1,1))}t.restore()};for(let w=0;w<y;w++)s(M+w*h,i,!1);v&&s(M+y*h,i,!0)}function te(t,u){const l=t.endsWith("_1")?"1":"0",y={U:`hero_walk_U_${l}`,D:`hero_walk_D_${l}`,L:`hero_walk_L_${l}`,R:`hero_walk_R_${l}`},v={U:`hero_up_${l}`,D:`hero_down_${l}`,L:t,R:t},M=y[u];if(n.sprites[M])return M;const i=v[u];return n.sprites[i]?i:t}function oe(t,u,l,y,v){const M=Math.min(1,l/.25),i=12,h=3,s=u==="R"?0:u==="L"?Math.PI:u==="U"?-Math.PI/2:Math.PI/2,w=(M-.5)*(Math.PI/2),T=s+w,g=Math.floor(y+8),S=Math.floor(v+8);t.save(),t.translate(g,S),t.rotate(T),t.fillStyle="#fff",t.fillRect(6,-h/2,i,h),t.restore()}let q=0,J=!1,z=!1;ue(t=>{if(J)return;const u=q>0?0:1,l=d.rooms[d.current],y=D.axis(),v=d.transitioning?{x:0,y:0,attack:!1}:y;ge(r,v,t*u,l.colliders),r.x<0&&l.exits.W&&(r.x=0,c.startTransition("W")),r.x+r.w>e.logicalW&&l.exits.E&&(r.x=e.logicalW-r.w,c.startTransition("E")),r.y<0&&l.exits.N&&(r.y=0,c.startTransition("N")),r.y+r.h>e.logicalH&&l.exits.S&&(r.y=e.logicalH-r.h,c.startTransition("S")),W(),c.update(t*u);const M=Y[d.current]||[];if(ke(M,r,t*u,l.colliders,e.logicalW,e.logicalH),j(d.current,t*u),B(d.current,t*u),r.invulnTime<=0){for(const i of M)if(!(r.x+r.w<=i.x||i.x+i.w<=r.x||r.y+r.h<=i.y||i.y+i.h<=r.y)){r.hearts=Math.max(0,r.hearts-1),r.invulnTime=1;const s=Math.sign(r.x-i.x)||1,w=Math.sign(r.y-i.y)||0;r.knockbackVx=s,r.knockbackVy=w,r.knockbackTime=.18;break}}if(r.state==="swing"){const i=E[d.current];if(i&&!i.purchased){const h=ee(r);if(h){const s={x:i.x,y:i.y,w:12,h:12};ae(h,s)&&$>=i.price&&($-=i.price,i.purchased=!0,r.maxHearts+=2,r.hearts=Math.min(r.hearts+2,r.maxHearts))}}}if(r.hearts<=0&&!J&&(J=!0,z=!0),c.justCompleted){const i=d.rooms[d.current],h=16,s=(g,S)=>g*h+(h-S)/2,w=g=>{let S=0,_=0,b=-1,k=0;for(let I=0;I<16;I++)i.colliders[g][I]===!1?(b===-1&&(b=I,k=0),k++):b!==-1&&(k>_&&(_=k,S=b),b=-1,k=0);return b!==-1&&k>_&&(_=k,S=b),_===0?8:S+Math.floor(_/2)},T=g=>{let S=0,_=0,b=-1,k=0;for(let I=0;I<15;I++)i.colliders[I][g]===!1?(b===-1&&(b=I,k=0),k++):b!==-1&&(k>_&&(_=k,S=b),b=-1,k=0);return b!==-1&&k>_&&(_=k,S=b),_===0?7:S+Math.floor(_/2)};switch(c.dir){case"S":{const g=w(0);r.x=Math.floor(s(g,r.w)),r.y=Math.floor(s(1,r.h)),r.dir="D";break}case"N":{const g=w(14);r.x=Math.floor(s(g,r.w)),r.y=Math.floor(s(13,r.h)),r.dir="U";break}case"E":{const g=T(0);r.x=Math.floor(s(1,r.w)),r.y=Math.floor(s(g,r.h)),r.dir="R";break}case"W":{const g=T(15);r.x=Math.floor(s(14,r.w)),r.y=Math.floor(s(g,r.h)),r.dir="L";break}}{const g=U();Y[d.current]=g[d.current]||[]}c.justCompleted=!1}r.state==="swing"&&Q()},()=>{const t=e.ctx2d;e.clear("#000");const u=d.rooms[d.current];if(d.transitioning&&c.prevId&&c.nextId){const M=d.rooms[c.prevId],i=d.rooms[c.nextId],h=c.progress(),s=Math.floor(-c.to.x*h),w=Math.floor(-c.to.y*h);for(let b=0;b<15;b++)for(let k=0;k<16;k++)G(t,M.tiles[b][k],k*16+s,b*16+w);for(let b=0;b<15;b++)for(let k=0;k<16;k++)G(t,i.tiles[b][k],k*16+s+c.to.x,b*16+w+c.to.y);const T=Math.floor(r.x+s),g=Math.floor(r.y+w);let S=le(r);S=te(S,r.dir);const _=r.dir==="L";N(t,S,T,g,_,0),r.state==="swing"&&oe(t,r.dir,r.animTime,T,g)}else{for(let g=0;g<15;g++)for(let S=0;S<16;S++)G(t,u.tiles[g][S],S*16,g*16);const M=L[d.current]||[];for(const g of M)C(t,g.x,g.y,g.color);const i=P[d.current]||[];for(const g of i){const S=[".11.1.","111111",".1111.","..11..","...1.."];t.save(),t.translate(Math.floor(g.x),Math.floor(g.y)),t.fillStyle="#e33";for(let _=0;_<S.length;_++){const b=S[_];for(let k=0;k<b.length;k++)b[k]==="1"&&t.fillRect(k,_,1,1)}t.restore()}{const g=E[d.current];if(g&&!g.purchased){t.fillStyle="#fff",t.font="10px monospace";const S=Math.floor(e.logicalW/2),_=(k,I)=>{const V=t.measureText(k).width;t.fillText(k,Math.floor(S-V/2),I)};if(_("Shop",12),_("Heart +1",24),_("10 Rupees",36),n.sprites.heart_full)N(t,"heart_full",g.x,g.y);else{t.save(),t.translate(Math.floor(g.x),Math.floor(g.y)),t.fillStyle="#e33";const k=[" .11.11. ","11111111","11111111",".111111.","..1111..","...11...","....1...."];for(let I=0;I<k.length;I++)for(let V=0;V<k[I].length;V++)k[I][V]==="1"&&t.fillRect(V,I,1,1);t.restore()}t.fillStyle="#fff",t.font="10px monospace";const b=`= ${g.price}`;if(n.sprites.rupee_green){const k=g.y,I=t.measureText(b).width+16,V=Math.floor(S-I/2);N(t,"rupee_green",V,k-8),t.fillText(b,V+18,k)}else{const k=`${g.price} Rupees`,I=t.measureText(k).width;t.fillText(k,Math.floor(S-I/2),g.y)}}}let h=le(r);h=te(h,r.dir);const s=r.dir==="L",w=Math.floor(r.x),T=Math.floor(r.y);N(t,h,w,T,s,0),r.state==="swing"&&oe(t,r.dir,r.animTime,w,T)}const l=Y[d.current]||[],y=ee(r);let v=0;if(y)for(let M=l.length-1;M>=0;M--){const i=l[M];if(ae(y,{x:i.x,y:i.y,w:i.w,h:i.h})){const h=r.swingId;if(i.lastHitSwingId!==h){i.hp=Math.max(0,(i.hp??10)-1),i.lastHitSwingId=h;const s=r.x+r.w/2,w=r.y+r.h/2,T=i.x+i.w/2,g=i.y+i.h/2;let S=Math.sign(T-s)||1,_=Math.sign(g-w)||0;const b=Math.hypot(S,_)||1;S/=b,_/=b;const k=i.scale&&i.scale>1?.25:.18;i.knockbackVx=S,i.knockbackVy=_,i.knockbackTime=k}if(i.hp<=0){l.splice(M,1),v++;const s=Math.random();s<.05?(L[d.current]||(L[d.current]=[])).push({x:i.x+4,y:i.y+4,vx:0,vy:-60,t:3,color:"#3498db",value:5,collectDelay:.2,landed:!1}):s<.25?(L[d.current]||(L[d.current]=[])).push({x:i.x+4,y:i.y+4,vx:0,vy:-60,t:3,color:"#2ecc71",value:1,collectDelay:.2,landed:!1}):s<.45&&(P[d.current]||(P[d.current]=[])).push({x:i.x+5,y:i.y+5,vx:0,vy:-80,t:3,collectDelay:.2,landed:!1})}}}v>0&&(q=.05);for(const M of l){const i=ve(M);N(t,i,Math.floor(M.x),Math.floor(M.y),!1,0,M.scale??1)}J?(t.fillStyle="#000",t.globalAlpha=.6,t.fillRect(0,0,e.logicalW,e.logicalH),t.globalAlpha=1,t.fillStyle="#fff",t.font="16px monospace",t.fillText("GAME OVER",e.logicalW/2-48,e.logicalH/2-6),t.font="10px monospace",t.fillText("Press any key to restart",e.logicalW/2-66,e.logicalH/2+10)):(r.hearts=Math.min(r.hearts,r.maxHearts),ce(t,r.hearts),o(t,$)),e.present(),q=Math.max(0,q-1/60)}),addEventListener("keydown",()=>{if(z){z=!1;for(const[t,u]of Object.entries(d.rooms)){for(let l=0;l<u.tiles.length;l++)for(let y=0;y<u.tiles[l].length;y++)u.tiles[l][y]==="chest_open"&&(u.tiles[l][y]="floor");for(const l of A[t]||[])u.tiles[l.y][l.x]="chest",u.colliders[l.y][l.x]=!0}F.clear();for(const t of Object.keys(L))L[t]=[];for(const t of Object.keys(P))P[t]=[];$=0,Y=U(),d.current="start",c.prevId=null,c.nextId=null,c.dir=null,d.transitioning=!1,d.cameraX=0,d.cameraY=0,r.x=8*16-6,r.y=7*16-6,r.dir="D",r.state="idle",r.animTime=0,r.hearts=6,r.invulnTime=0,r.knockbackTime=0,J=!1,q=0}},{passive:!0})}const be=new de;Me(be).catch(e=>{const n=document.createElement("pre");n.style.position="fixed",n.style.left="8px",n.style.bottom="8px",n.style.color="#f66",n.textContent=String((e==null?void 0:e.stack)||e),document.body.appendChild(n)});
